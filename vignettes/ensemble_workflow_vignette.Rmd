---
title: "r2ogs6 Ensemble Guide"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{r2ogs6 Ensemble Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.align = "center",
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)

devtools::load_all(".")
```

```{r setup}
library(r2ogs6)
library(ggplot2)
library(dplyr)
```

## Introduction
Hi there! This is a practical guide on the `OGS6_Ensemble` class from the `r2ogs6` package. I will show you how you can use this class to set up ensemble runs for OpenGeoSys 6, extract the results and plot them.

If you want to follow this tutorial, you'll need to have `r2ogs6` installed and loaded. The prerequisites for `r2ogs6` are described in detail in the `r2ogs6 User Guide` vignette. 

Additionally, you'll need the following benchmark files:

* [Theis' Problem](https://gitlab.opengeosys.org/ogs/ogs/-/tree/master/Tests/Data/Parabolic/LiquidFlow/AxiSymTheis) as described [here](https://www.opengeosys.org/docs/benchmarks/liquid-flow/liquid-flow-theis-problem/)

* [Theis solution for well pumping](https://gitlab.opengeosys.org/ogs/ogs/-/tree/master/Tests/Data/Parabolic/ComponentTransport/Theis) as described [here](https://www.opengeosys.org/docs/benchmarks/hydro-component/theis/hc_theis/)

General instructions on how to download OpenGeoSys 6 benchmark files can be found [here](https://www.opengeosys.org/docs/userguide/basics/introduction/#download-benchmarks).

## Theis' problem

We will consider the following parameters for our sensitivity analysis:

* `permeability`

* `porosity`

* `storage`


### Setup

First, we create a simulation object to base our ensemble on and read in the `.prj` file.

```{r}
# Change this to fit your system
testdir_path <- system.file("extdata/test_tempdirs/", package = "r2ogs6")
sim_path <- paste0(testdir_path, "/axisym_theis_sim")

ogs6_obj <- OGS6$new(sim_name = "axisym_theis",
                     sim_id = 1,
                     sim_path = sim_path)

# Change this to fit your system
prj_path <- system.file("examples/Theis_problem/benchmark_files/",
                        "axisym_theis.prj", package = "r2ogs6")

read_in_prj(ogs6_obj, prj_path)
```


### Single-parameter sequential run

Let's create a small ensemble where we only alter the value of `storage`. Say we don't want to hardcode the values, but instead examine the effects of changing `storage` by 1%, 10% and 50%. We can use the `percentages_mode` parameter of `OGS6_Ensemble` for this. It already defaults to `TRUE`, below I'm merely being explicit for demonstration purposes.

```{r}
# Assign percentages to a variable in case we want to reuse them later
percentages <- c(-50, -10, -1, 0, 1, 10, 50)

# Define an ensemble object
ogs6_ens <- 
  OGS6_Ensemble$new(
    ogs6_obj = ogs6_obj,
    parameters = list(list(ogs6_obj$media[[1]]$properties[[4]]$value,
                           percentages)),
    percentages_mode = TRUE)

# Now we run the simulations
exit_codes <- ogs6_ens$ogs_run_simulation()
paste(exit_codes, collapse = " ")
```

#### Plot results for single simulation

Our simulations (hopefully) ran successfully - great! Now it'd be nice to see some results. Say we're interested in the `pressure` data.

```{r}
# This will get a list of tibbles - one for each simulation.
storage_tbls <- 
  lapply(ogs6_ens$ensemble, function(x){
    x$pvds[[1]]$get_point_data(point_ids = c(0, 1, 2),
                               Names = c("pressure"))
  })
```

You may leave out the `point_ids` parameter. It defaults to all points in the dataset - I specify it here because there's about 500 which would slow down building this vignette.

```{r}
# Let's look at the first 10 rows of the dataset for the first simulation.
head(storage_tbls[[1]], 10)
```

You can see there's one row per timestep for each point ID. Say we want to plot the *average* pressure for each `timestep`, that is, the mean of the `pressure` values where the rows have the same `timestep`.

```{r}
# Get average pressure from first dataframe (= from first simulation)
avg_pr_df <- storage_tbls[[1]] %>% 
  group_by(timestep) %>%
  summarise(avg_pressure = mean(pressure))
avg_pr_df
```


```{r}
# Plot pressure over time for first simulation
ggplot(data = avg_pr_df) + 
  geom_point(mapping = aes(x = as.numeric(row.names(avg_pr_df)),
                           y = avg_pressure)) + xlab("Timestep")


```

#### Plot results for multiple simulations

```{r}
# Prepare dataframes for plotting
reformatted_dfs <- list()

for(i in seq_len(length(storage_tbls))){

  tbl <- storage_tbls[[i]] %>% 
    group_by(timestep) %>%
    summarise(avg_pressure = mean(pressure))
  
  # Add column so we can separate values based on their old df 
  tbl$df_id <- rep(i, nrow(tbl))
  
  # Add column so we can plot based on old df rownames
  tbl$orig_rwns <- as.numeric(row.names(tbl))
  
  reformatted_dfs <- c(reformatted_dfs, list(tbl))
}

# Combine dataframes into single dataframe for plot
avg_pr_combined_df <- bind_rows(reformatted_dfs)

# Make plot
ggplot(avg_pr_combined_df,
       aes(x = orig_rwns,
           y = avg_pressure)) +
  geom_point(aes(color = as.factor(df_id))) +
  geom_line(aes(color = as.factor(df_id))) + 
  xlab("Timestep") + 
  labs(color = "sim id") +
  facet_grid(rows = vars(df_id))

```

Now we have the average `pressure` over time for each of the simulations (rows). Since they're pretty similar, let's put them in the same plot for a better comparison.

```{r}
ggplot(avg_pr_combined_df, aes(x = orig_rwns,
                               y = avg_pressure,
                               group = df_id)) +
  geom_point(aes(color = as.factor(df_id))) +
  geom_line(aes(color = as.factor(df_id))) + 
  labs(color = "sim id") +
  xlab("Timestep")
```

### Multi-parameter sequential run

So far we've only considered the `storage` parameter. Now we want to have a look at how the other two parameters influence the simulation, so let's put them into an ensemble together. For `permeability` we can reuse the `percentages` we already have. For `porosity`, this doesn't work - the original value is 1 and its values can only range between 0 and 1, so we'll supply a shorter vector.

This time it's important we set the `OGS6_Ensemble` parameter `sequential_mode` to `TRUE` as this will change the supplied parameters *sequentially* which means in the end we have 18 (7 + 7 + 4) simulations which is equal to the sum of elements in the value vectors you supply (I've named them `values` below for clarity, naming them is optional though).

The default `FALSE` would give an error message because our value vectors do not have the same length and even if they had, it wouldn't do what we want - the number of simulations would equal the length of *one* value vector (thus requiring them to be of the same length). Generally, set `sequential_mode` to `TRUE` if you want to examine the influence of parameters on a simulation *independently*. If you want to examine how the parameters influence *each other* as in wanting to test parameter combinations, the default mode is the way to go. 

```{r}
# Change this to fit your system
testdir_path <- system.file("extdata/test_tempdirs/", package = "r2ogs6")
sim_path <- paste0(testdir_path, "/axisym_theis_sim_big")

ogs6_obj$sim_path <- sim_path

ogs6_ens_big <-
  OGS6_Ensemble$new(
    ogs6_obj = ogs6_obj,
    parameters = list(per = list(ogs6_obj$media[[1]]$properties[[1]]$value, 
                                 values = percentages),
                      por = list(ogs6_obj$media[[1]]$properties[[3]]$value, 
                                 c(-50, -10, -1, 0)),
                      sto = list(ogs6_obj$media[[1]]$properties[[4]]$value, 
                                 values = percentages)),
    sequential_mode = TRUE)

exit_codes <- ogs6_ens_big$ogs_run_simulation()
paste(exit_codes)
```

This will take a short time. As soon as the simulations are done, we can extract the point data much like we did before. This time we want to plot the point x coodinates on the x axis so we're leaving out `point_ids` to get all points. Also we just want the data from the last timestep.

```{r}
# This will get a list of tibbles - one for each simulation.
per_por_sto_tbls <- 
  lapply(ogs6_ens_big$ensemble, function(x){
    x$pvds[[1]]$get_point_data(Names = c("pressure"),
                               start_at_timestep = x$pvds[[1]]$last_timestep)
  })
```

Plotting time? Not quite. We can't really differentiate what values were used where yet. Since we set `sequential_mode` to `TRUE`, `OGS_Ensemble` allows us to utilize `relevant_parameter_at()` to fix this. It looks up which value vector the parameter we changed for each simulation came from. We will also put in an extra column `percs` so we can group by percentages.

```{r}
# Get list of dataframes
x_pr_dfs <- list()

for(i in seq_len(length(per_por_sto_tbls))){
  new_df <- per_por_sto_tbls[[i]]
  
  # Add name and deviation column
  new_df$name <- ogs6_ens_big$relevant_parameter_at(i)
  new_df$percs <- unlist(ogs6_ens_big$parameter_percs)[[i]]
  
  x_pr_dfs <- c(x_pr_dfs, list(new_df))
}

# Combine dataframes into single dataframe 
x_pr_combined_df <- bind_rows(x_pr_dfs)
```

*Now* it's plotting time. We group our variables corresponding to the deviations and then use a facet grid with the `name` parameter we added to the dataframes.

```{r}
# Make plot
ggplot(x_pr_combined_df,
       aes(x = x,
           y = pressure,
           group = percs)) +
  geom_point(aes(color = as.factor(percs))) +
  xlab("x point coordinate") +
  labs(color = "%") +
  facet_grid(cols = vars(name))
```

Ta-Daa! All nicely grouped. We can see `permeability` has the most influence on the pressure. Though they may seem suspicious, `porosity` and `storage` are being plotted correctly - the points are just being placed right on top of each other. Since `porosity` can't go over the value `1` which was the original value, our value vector only went from -50% to 0% which is why the line colors of `porosity` and `storage` differ.


## Theis solution for well pumping

We will consider the following parameters for our sensitivity analysis:

* `permeability`

* `porosity`

* `slope`


setup

plot single

```{r, include = FALSE}
# Cleanup created folders
do.call(file.remove, list(list.files(testdir_path, full.names = TRUE)))
```